#!/usr/bin/env bash

# Ensure WWWUSER is set, default to www-data's UID (usually 33)
WWWUSER=${WWWUSER:-33}
WWWGROUP=${WWWGROUP:-33}

# Update www-data UID and GID if necessary
usermod -u "$WWWUSER" www-data 2>/dev/null || true
groupmod -g "$WWWGROUP" www-data 2>/dev/null || true

# Ensure Composer directory is writable
mkdir -p /.composer
chmod -R ug+rw /.composer
chown -R www-data:www-data /.composer

# Set correct permissions for Laravel storage directories
if [ -d /var/www/html/storage ] && [ -d /var/www/html/bootstrap/cache ]; then
    chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache
    chmod -R ug+rwX /var/www/html/storage /var/www/html/bootstrap/cache
fi

# Execute command or start supervisord
if [ $# -gt 0 ]; then
    exec gosu www-data "$@"
else
    exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
fi
